from launch import LaunchDescription
from launch.actions import (
    DeclareLaunchArgument,
    EmitEvent,
    ExecuteProcess,
    LogInfo,
    RegisterEventHandler,
    TimerAction
)
from launch.conditions import IfCondition
from launch.event_handlers import (
    OnExecutionComplete,
    OnProcessExit,
    OnProcessIO,
    OnProcessStart,
    OnShutdown
)
from launch.events import Shutdown
from launch.substitutions import (
    EnvironmentVariable,
    FindExecutable,
    LaunchConfiguration,
    LocalSubstitution,
    PythonExpression
)
from launch_ros.actions import Node

from ament_index_python.packages import get_package_share_directory
import os


def generate_launch_description():
    turtlesim_ns = LaunchConfiguration('turtlesim_ns')
    use_provided_red = LaunchConfiguration('use_provided_red')
    new_background_r = LaunchConfiguration('new_background_r')

    turtlesim_ns_launch_arg = DeclareLaunchArgument(
        'turtlesim_ns',
        default_value='turtlesim1'
    )
    use_provided_red_launch_arg = DeclareLaunchArgument(
        'use_provided_red',
        default_value='False'
    )
    new_background_r_launch_arg = DeclareLaunchArgument(
        'new_background_r',
        default_value='200'
    )

    turtlesim_node = Node(
        package='turtlesim',
        namespace=turtlesim_ns,
        executable='turtlesim_node',
        name='sim'
    )

    # ros2 launch turtlebot3_gazebo empty_world.launch.py
    spawn_turtlebot = ExecuteProcess(
        cmd=[[
            FindExecutable(name='ros2'),
            ' launch ',
            'turtlebot3_gazebo ',
            'empty_world.launch.py ',
        ]],
        shell=True
    )

    # ros2 run pid_turtlebot3 turtlebot3_pid_cntl --ros-args --params-file params.yaml
    # pid controller node, get path name first
    config = os.path.join(
        get_package_share_directory('pid_turtlebot3'),
        'config',
        'params.yaml'
        )

    # pid controller node
    pid_node = Node(
        package='pid_turtlebot3',
        executable='turtlebot3_pid_cntl',
	    parameters=[config]
    )

    launch_controller = ExecuteProcess(
        cmd=[[
            FindExecutable(name='ros2'),
            ' param set ',
            turtlesim_ns,
            '/sim background_r ',
            '120'
        ]],
        shell=True
    )
    change_background_r_conditioned = ExecuteProcess(
        condition=IfCondition(
            PythonExpression([
                new_background_r,
                ' == 200',
                ' and ',
                use_provided_red
            ])
        ),
        cmd=[[
            FindExecutable(name='ros2'),
            ' param set ',
            turtlesim_ns,
            '/sim background_r ',
            new_background_r
        ]],
        shell=True
    )

    return LaunchDescription([
        #turtlesim_ns_launch_arg,
        #use_provided_red_launch_arg,
        #new_background_r_launch_arg,
        #turtlesim_node,
        spawn_turtlebot,
        RegisterEventHandler(
            OnProcessStart(
                target_action=spawn_turtlebot,
                on_start=[
                    LogInfo(msg='Turtlebot3 and gazebo started, spawning bot'),
                    #spawn_turtle
                ]
            )
        ),
        RegisterEventHandler(
            OnProcessIO(
                target_action=spawn_turtlebot,
                on_stdout=lambda event: LogInfo(
                    msg='CODY CODY Spawn request says "{}"'.format(
                        event.text.decode().strip())
                )
            )
        ),
        RegisterEventHandler(
            OnExecutionComplete(
                target_action=spawn_turtlebot,
                on_completion=[
                    LogInfo(msg='Spawn finished'),
                    pid_node,
                    #TimerAction(
                    #    period=2.0,
                    #    actions=[change_background_r_conditioned],
                    #)
                ]
            )
        ),
        RegisterEventHandler(
            OnProcessExit(
                target_action=spawn_turtlebot,
                on_exit=[
                    LogInfo(msg=(EnvironmentVariable(name='USER'),
                            ' closed the turtlesim window')),
                    EmitEvent(event=Shutdown(
                        reason='Window closed'))
                ]
            )
        ),
        RegisterEventHandler(
            OnShutdown(
                on_shutdown=[LogInfo(
                    msg=['Launch was asked to shutdown: ', LocalSubstitution('event.reason')]
                )]
            )
        ),
    ])
